%%% LaTeX style file for the documentation of the configuration file

%% ===================================================================
%% Preamble
%% ===================================================================

\NeedsTeXFormat{LaTeX2e}

\ProvidesExplPackage
  {configuration}
  {2023-10-01}
  {0.1.0}
  {LaTeX style for documentation of NixOS configuration}

%% ===================================================================
%% Fonts
%% ===================================================================

\RequirePackage [ T1 ] { fontenc}
\RequirePackage { newpxtext }
\RequirePackage [ scaled = 0.95 ] { inconsolata }
\RequirePackage { newpxmath }

%% ===================================================================
%% Page layout
%% ===================================================================

\RequirePackage [
  paperheight = 7.9 in,
  paperwidth = 4.5 in,
  top = 0.2 in,
  bottom = 0.2 in,
  inner = 0.2 in,
  outer = 0.2 in,
  bindingoffset = 0 in,
  includehead = true,
  headheight = 15 pt,
  headsep = \baselineskip,
  twoside = false
]
  { geometry }

%% ===================================================================
%% Page headers and footers
%% ===================================================================

\RequirePackage { fancyhdr }
\pagestyle { fancy }
\fancyhf {}

\fancyhead [ L ]
  {
    \nouppercase { \leftmark }
    \nouppercase { \rightmark }
  }

\fancyhead [ R ] { \thepage }

\AddToHook { cmd / section / before }
  { \clearpage }

\cs_gset:cpn { sectionmark } #1
  {
    \markboth { \thesection. ~ #1 } {}
  }

\cs_gset:cpn { subsectionmark } #1
  {
    \markright { ~ \textbar{} ~ \thesubsection. ~ #1 }
  }

%% ===================================================================
%% Title page
%% ===================================================================

\RequirePackage { titling }

\AfterEndEnvironment { titlingpage }
  {
    \stepcounter { page }
  }

%% ===================================================================
%% Keywords
%% ===================================================================

\NewDocumentCommand \ghtopics
  { m }
  {
    \hypersetup { pdfkeywords = {#1} }
    \par
    \medskip
    \textit{GitHub ~ topics}: ~
    \clist_set:cn { l_tmpa_clist } {#1}
    \clist_clear:c { l_tmpb_clist }
    \clist_map_inline:cn { l_tmpa_clist }
      {
        \clist_put_right:cn { l_tmpb_clist }
          {
            \href { https://github.com/topics/##1.html } {##1}
          }
      }
    \clist_use:cn { l_tmpb_clist } { , ~ }
  }

%% ===================================================================
%% Table of contents
%% ===================================================================

\RequirePackage { tocloft }

\tocloftpagestyle { fancy }

\cs_gset:cpn { cftmarktoc }
  {
    \markboth { Contents } {}
  }

%% ===================================================================
%% Bibliography
%% ===================================================================

\RequirePackage
  [
    alldates = iso,
    backref = true,
    backrefstyle = none,
    block = par,
    seconds = true,
    style = authoryear
  ]
  { biblatex }

\setcounter { biburllcpenalty }
  { 9000 }

\renewbibmacro { pageref }
  {
    \iflistundef { pageref }
      {
        \printtext
          [ parens ]
          { not ~ cited }
      }
      {
        \printtext
          [ parens ]
          {
            \ifnumgreater { \value { pageref } } {1}
              {
                \bibstring { backrefpages }
                \ppspace
              }
              {
                \bibstring { backrefpage }
                \ppspace
              }
            \printlist
              [ pageref ]
              [ - \value { listtotal } ]
              { pageref }
          }
      }
  }

\DefineBibliographyStrings
  { english }
  {
    backrefpage = { cited ~ on ~ p \adddot },
    backrefpages = { cited ~ on ~ pp \adddot },
    urlseen = { seen }
  }

\defbibheading { mybibliography }
  [ \bibname ]
  {
    \section* {#1}
    \markboth {#1} {}
    \addcontentsline { toc }{ section } {#1}
  }

\NewDocumentCommand \bibsection
  { O{References} }
  {
    \clearpage
    \phantomsection
    \printbibliography
      [
        heading = mybibliography,
        title = #1
      ]
  }

\dim_gset:cn { bibitemsep } { 2 \itemsep }

%% ===================================================================
%% Hypertext
%% ===================================================================

\RequirePackage { url }
\urlstyle { same }
\RequirePackage [ numbered ]{ bookmark }
\RequirePackage { hyperref }
\hypersetup { hypertexnames = false }
\hypersetup { colorlinks = true }
% https://tex.stackexchange.com/a/632828
\hypersetup { allcolors = blue!80!white }
\hypersetup { pdflang = { en } }

\NewDocumentCommand \filename
  { m }
  {
    \guillemetleft
    \nolinkurl {#1}
    \guillemetright
  }

%% ===================================================================
%% Cross-references
%% ===================================================================

\RequirePackage { cleveref }

%% ===================================================================
%% Noweb
%% ===================================================================

\RequirePackage { noweb }

\cs_gset:cpn { nwmargintag } #1
  {
    \group_begin:
    \leavevmode
    \kern -\codemargin
    #1.
    \kern \codemargin
    \group_end:
  }

\cs_gset:cpn { nwalsodefined } #1
  { \scan_stop: }

\cs_gset:cpn { nwused } #1
  { \scan_stop: }

\cs_gset:cpn { nwnotused } #1
  { \scan_stop: }

\cs_gset:cpn { nwidentuses } #1
  { \scan_stop: }

\cs_gset:cpn { nwidentdefs } #1
  { \scan_stop: }

\noweboptions
  {
    breakcode,
    smallcode
  }

\NewDocumentCommand \nwverb
  { v }
  {
    \code #1 \edoc
  }

\NewDocumentCommand \nowebchunkssection
  { O{List ~ of ~ code ~ chunks} }
  {
    \clearpage
    \phantomsection
    \addcontentsline { toc }{ section } {#1}
    \section* {#1}
    \markboth {#1} {}
    \nowebchunks
  }

\NewDocumentCommand \nowebindexsection
  { O{List ~ of ~ identifiers} }
  {
    \clearpage
    \phantomsection
    \addcontentsline { toc }{ section } {#1}
    \markboth {#1} {}
    \section* {#1}
    \nowebindex
  }

\RequirePackage [ svgnames ]{ xcolor }
\RequirePackage { tcolorbox }

\tcbuselibrary
  {
    breakable,
    skins
  }

\newtcolorbox { codechunk }
  {
    after = ,
    breakable = true,
    colback = blue!4!white,
    colframe = tcbcolback,
    enhanced = true,
    interior ~ style = fill,
    sharp ~ corners,
    size = minimal,
    top = 4 pt
  }

\tcolorboxenvironment { verbatim }
  {
    after = \par\noindent,
    breakable = true,
    colback = black!4!white,
    colframe = tcbcolback,
    enhanced = true,
    fontupper = \small,
    interior ~ style = fill,
    sharp ~ corners,
    size = small
  }

\NewDocumentCommand \firstterm
  { m }
  {
    \emph {#1}
  }

%% ===================================================================
%% Dummy text
%% ===================================================================

\RequirePackage { kantlipsum }


%% End of file

%% Local Variables:
%% mode: fundamental
%% tab-width: 2
%% End:
